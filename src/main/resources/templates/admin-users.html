<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{adminUsers.title}">All Users</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin-top: 30px; }
        .card { padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
        .btn-toggle { background:#2980b9; color:white; border:none; padding:6px 10px; border-radius:6px; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
    </style>
</head>
<body>
<div class="top-bar">
    <h4>üåç Travel Agency - Admin</h4>
    <div>
        <button onclick="goCatalog()" class="btn btn-secondary" th:text="#{admin.back}">Back</button>
    </div>
</div>

<div class="lang-switch">
    <a th:href="@{/admin/users(lang='en')}">EN</a>
    <a th:href="@{/admin/users(lang='uk')}">UA</a>
    <a th:href="@{/admin/users(lang='fr')}">FR</a>
    <a th:href="@{/admin/users(lang='de')}">DE</a>
    <a th:href="@{/admin/users(lang='es')}">ES</a>
</div>

<div class="container">
    <div class="card">
        <h3 th:text="#{adminUsers.title}">All Users</h3>
        <p th:text="#{adminUsers.description}">List of registered users.</p>
        <span id="activateText" th:text="#{admin.user.activate}" hidden>Activate</span>
        <span id="deactivateText" th:text="#{admin.user.deactivate}" hidden>Deactivate</span>
        <span id="userYes" th:text="#{label.yes}" hidden>Yes</span>
        <span id="userNo" th:text="#{label.no}" hidden>No</span>
        <span id="userUpdated" th:text="#{admin.user.updated}" hidden>User updated successfully</span>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th th:text="#{user.username}">Username</th>
                    <th th:text="#{user.email}">Email</th>
                    <th th:text="#{user.name}">Name</th>
                    <th th:text="#{user.balance}">Balance</th>
                    <th th:text="#{user.active}">Active</th>
                    <th th:text="#{adminUsers.actions}">Actions</th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
    </div>
</div>

<div id="message-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
    <div id="message-box" style="background:white; padding:30px 40px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.3); text-align:center; max-width:400px;">
        <div id="message-text"></div>
        <button onclick="closeMessage()" style="margin-top:15px; padding:6px 14px; border:none; border-radius:6px; background:#2980b9; color:white;">OK</button>
    </div>
</div>

<script th:inline="javascript">
    function goCatalog(){ window.location.href='/catalog'; }
    function showMessage(msg){ document.getElementById('message-text').innerText = msg; document.getElementById('message-overlay').style.display='flex'; }
    function closeMessage(){ document.getElementById('message-overlay').style.display='none'; }

    async function loadUsers(){
        const token = localStorage.getItem('jwt');
        const headers = {};
        if(token) headers['Authorization'] = 'Bearer ' + token;
        try{
            const resp = await fetch('/api/users/all', { headers, credentials: 'same-origin' });
            if(!resp.ok) { showMessage('Failed to load'); return; }
            const data = await resp.json();
            const users = Array.isArray(data.results) ? data.results : [];
            const tbody = document.getElementById('usersBody'); tbody.innerHTML = '';
            users.forEach((u,i)=>{
                const yesText = document.getElementById('userYes')?.innerText || 'Yes';
                const noText = document.getElementById('userNo')?.innerText || 'No';
                const activateText = document.getElementById('activateText')?.innerText || 'Activate';
                const deactivateText = document.getElementById('deactivateText')?.innerText || 'Deactivate';
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.firstName || ''} ${u.lastName || ''}</td>
                        <td>${u.balance != null ? u.balance : ''} $</td>
                        <td>${u.active ? yesText : noText}</td>
                        <td><button class="btn-toggle" onclick="toggleActive('${u.id}', ${u.active})">${u.active ? deactivateText : activateText}</button></td>
                    </tr>
                `;
            });
        }catch(e){ console.error(e); showMessage('Error'); }
    }

    function toggleActive(id, current){
        const token = localStorage.getItem('jwt');
        const headers = {'Content-Type':'application/json'}; if(token) headers['Authorization'] = 'Bearer ' + token;
        const newValue = !current;
        fetch(`/api/users/${id}/active`, { method: 'PATCH', headers, credentials: 'same-origin', body: JSON.stringify({active:newValue}) })
            .then(r=>r.json())
            .then(d=>{
                if(d && d.statusCode === 'OK'){
                    const msg = document.getElementById('userUpdated')?.innerText || d.statusMessage || 'Updated';
                    showMessage(msg); loadUsers();
                } else {
                    showMessage(d.message || 'Failed');
                }
            }).catch(e=>{ console.error(e); showMessage('Error'); });
    }

    window.onload = ()=>{ loadUsers(); };
</script>
</body>
</html>
