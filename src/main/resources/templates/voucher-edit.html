<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{myVoucherEdit.title}">Edit Voucher</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h4 { margin: 0; color: #2c3e50; font-weight: 600; }
        .top-right { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; color: #2c3e50; }
        .balance { font-weight: 600; color: #27ae60; }
        .btn-logout { background-color: #e74c3c; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-logout:hover { background-color: #c0392b; }
        .btn-my-vouchers { background-color: #2980b9; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-my-vouchers:hover { background-color: #1c5980; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        .lang-switch a:hover { background-color: #1e8449; }
        .container { max-width: 700px; margin-top: 30px; }
        .form-card { background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; }
        .form-card label { font-weight: 600; }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; font-size: 1.1rem; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        #message-box button:hover { background-color: #1c5980; }
    </style>
</head>
<body>
<div class="top-bar">
    <h4>üåç Travel Agency</h4>
    <div class="top-right">
        <div class="user-name" id="userName" th:text="#{catalog.userName}">User Name</div>
        <div class="balance" id="balance" th:text="#{catalog.balance}">Balance: 0.00 $</div>
        <button class="btn-my-vouchers" onclick="goBackCatalog()" th:text="#{myVouchers.backCatalog}">Back to Catalog</button>
        <button class="btn-logout" onclick="logout()" th:text="#{catalog.logout}">Logout</button>
    </div>
</div>

<div class="lang-switch">
    <a th:href="@{/admin/vouchers/{id}/edit(id=${voucher.id},lang='en')}">EN</a>
    <a th:href="@{/admin/vouchers/{id}/edit(id=${voucher.id},lang='uk')}">UA</a>
    <a th:href="@{/admin/vouchers/{id}/edit(id=${voucher.id},lang='fr')}">FR</a>
    <a th:href="@{/admin/vouchers/{id}/edit(id=${voucher.id},lang='de')}">DE</a>
    <a th:href="@{/admin/vouchers/{id}/edit(id=${voucher.id},lang='es')}">ES</a>
</div>

<div class="container">
    <div class="form-card">
        <label th:for="title" th:text="#{catalog.titleCol}">Title</label>
        <input type="text" id="title" th:value="${voucher.title}" class="form-control">

        <label th:for="description" th:text="#{catalog.description}">Description</label>
        <textarea id="description" class="form-control" rows="3" th:text="${voucher.description}"></textarea>

        <label th:for="price" th:text="#{catalog.price}">Price</label>
        <input type="number" id="price" min="0" step="0.01" class="form-control" th:value="${voucher.price}">

        <label th:for="tourType" th:text="#{catalog.tour}">Tour</label>
        <select id="tourType" class="form-control" th:value="${voucher.tourType}">
            <option value="HEALTH">HEALTH</option>
            <option value="SPORTS">SPORTS</option>
            <option value="LEISURE">LEISURE</option>
            <option value="SAFARI">SAFARI</option>
            <option value="WINE">WINE</option>
            <option value="ECO">ECO</option>
            <option value="ADVENTURE">ADVENTURE</option>
            <option value="CULTURAL">CULTURAL</option>
        </select>

        <label th:for="transferType" th:text="#{catalog.transfer}">Transfer</label>
        <select id="transferType" class="form-control" th:value="${voucher.transferType}">
            <option value="BUS">BUS</option>
            <option value="TRAIN">TRAIN</option>
            <option value="PLANE">PLANE</option>
            <option value="SHIP">SHIP</option>
            <option value="PRIVATE_CAR">PRIVATE_CAR</option>
            <option value="JEEPS">JEEPS</option>
            <option value="MINIBUS">MINIBUS</option>
            <option value="ELECTRICAL_CARS">ELECTRICAL_CARS</option>
        </select>

        <label th:for="hotelType" th:text="#{catalog.hotel}">Hotel</label>
        <select id="hotelType" class="form-control" th:value="${voucher.hotelType}">
            <option value="ONE_STAR">ONE_STAR</option>
            <option value="TWO_STARS">TWO_STARS</option>
            <option value="THREE_STARS">THREE_STARS</option>
            <option value="FOUR_STARS">FOUR_STARS</option>
            <option value="FIVE_STARS">FIVE_STARS</option>
        </select>

        <label th:for="arrivalDate" th:text="#{myVoucherEdit.arrivalDate}">Arrival Date</label>
        <input type="date" id="arrivalDate" class="form-control" th:value="${voucher.arrivalDate}">

        <label th:for="evictionDate" th:text="#{myVoucherEdit.evictionDate}">Eviction Date</label>
        <input type="date" id="evictionDate" class="form-control" th:value="${voucher.evictionDate}">

        <button class="btn-save" onclick="saveVoucher()" th:text="#{myVoucherEdit.save}">Save</button>
    </div>
</div>

<!-- localized validation messages -->
<span id="invalidDatesText" th:text="#{myVoucherEdit.invalidDates}" hidden>Eviction date must be after arrival date</span>
<span id="priceTooLowText" th:text="#{myVoucherEdit.priceTooLow}" hidden>Price must be at least 10$</span>

<div id="message-overlay">
    <div id="message-box">
        <div id="message-text"></div>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>

<script th:inline="javascript">
    async function saveVoucher() {
        const voucherId = /*[[${voucher.id}]]*/ '0';
        const arrivalValue = document.getElementById('arrivalDate').value;
        const evictionValue = document.getElementById('evictionDate').value;
        const priceValue = document.getElementById('price').value;

        const invalidMsg = document.getElementById('invalidDatesText')?.innerText || 'Eviction date must be after arrival date';
        const priceTooLowMsg = document.getElementById('priceTooLowText')?.innerText || 'Price must be at least 10$';


        if (priceValue !== '') {
            const priceNum = parseFloat(priceValue);
            if (!isNaN(priceNum) && priceNum < 10) {
                showMessage(priceTooLowMsg, 'error');
                return;
            }
        }

        if (arrivalValue && evictionValue) {
            const arrival = new Date(arrivalValue);
            const eviction = new Date(evictionValue);
            // if eviction is before or equal to arrival -> invalid
            if (eviction <= arrival) {
                showMessage(invalidMsg, 'error');
                return;
            }
        }

        const data = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            price: parseFloat(priceValue),
            tourType: document.getElementById('tourType').value,
            transferType: document.getElementById('transferType').value,
            hotelType: document.getElementById('hotelType').value,
            arrivalDate: arrivalValue,
            evictionDate: evictionValue
        };

        const token = localStorage.getItem('jwt');
        try {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;

            const response = await fetch(`/api/vouchers/${voucherId}`, {
                method: 'PATCH',
                headers: headers,
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });

            const res = await response.json();
            if(!response.ok) {
                showMessage(res.message || 'Failed to save voucher', 'error');
                return;
            }
            showMessage('Voucher saved successfully!', 'success');
            setTimeout(()=>window.location.href='/catalog',1000);
        } catch(err) {
            showMessage(err.message, 'error');
        }
    }

    function showMessage(msg, type='success'){
        const overlay=document.getElementById('message-overlay');
        const box=document.getElementById('message-box');
        box.className=type;
        document.getElementById('message-text').innerText=msg;
        overlay.style.display='flex';
    }

    function closeMessage(){ document.getElementById('message-overlay').style.display='none'; }
    function goBack() {
    window.location.href = "https://localhost:8443/catalog";
}

    async function loadUserInfo() {
        const token = localStorage.getItem('jwt'); if(!token) return;
        try {
            const response = await fetch('/api/users/me',{headers:{'Authorization':'Bearer '+token}});
            if(!response.ok) return;
            const user = await response.json();
            if(user) {
                document.getElementById('userName').innerText = `${user.firstName} ${user.lastName}`;
                document.getElementById('balance').innerText = `${user.balance.toFixed(2)} $`;
            }
        } catch(e){ console.warn('Failed to load user info'); }
    }

    function logout() { localStorage.removeItem('jwt'); showMessage([[#{catalog.logoutSuccess}]], 'success'); setTimeout(()=>window.location.href='/login',1000); }

    window.onload = ()=>{ loadUserInfo(); };
</script>
</body>
</html>
