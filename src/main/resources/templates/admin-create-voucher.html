<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{admin.createVoucher.title}">Create Voucher</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 700px; margin-top: 30px; }
        .form-card { background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 12px; }
        .form-card label { font-weight: 600; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); max-width: 420px; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box ul { padding-left: 20px; margin: 0; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <h4>üåç Travel Agency - Admin</h4>
    <button onclick="goAdmin()" class="btn btn-secondary" th:text="#{admin.back}">Back</button>
</div>

<div class="lang-switch">
    <a th:href="@{/admin/create-voucher(lang='en')}">EN</a>
    <a th:href="@{/admin/create-voucher(lang='uk')}">UA</a>
    <a th:href="@{/admin/create-voucher(lang='fr')}">FR</a>
    <a th:href="@{/admin/create-voucher(lang='de')}">DE</a>
    <a th:href="@{/admin/create-voucher(lang='es')}">ES</a>
</div>

<div class="container">
    <div class="form-card">
        <h3 th:text="#{admin.createVoucher.title}">Create Voucher</h3>

        <label th:text="#{catalog.titleCol}">Title</label>
        <input id="title" class="form-control"/>

        <label th:text="#{catalog.description}">Description</label>
        <textarea id="description" class="form-control"></textarea>

        <label th:text="#{catalog.price}">Price</label>
        <input id="price" type="number" min="0" step="0.01" class="form-control"/>

        <label th:text="#{catalog.tour}">Tour</label>
        <select id="tourType" class="form-control">
            <option value="">---</option>
            <option value="HEALTH">HEALTH</option>
            <option value="SPORTS">SPORTS</option>
            <option value="LEISURE">LEISURE</option>
            <option value="SAFARI">SAFARI</option>
            <option value="WINE">WINE</option>
            <option value="ECO">ECO</option>
            <option value="ADVENTURE">ADVENTURE</option>
            <option value="CULTURAL">CULTURAL</option>
        </select>

        <label th:text="#{catalog.transfer}">Transfer</label>
        <select id="transferType" class="form-control">
            <option value="">---</option>
            <option value="BUS">BUS</option>
            <option value="TRAIN">TRAIN</option>
            <option value="PLANE">PLANE</option>
            <option value="SHIP">SHIP</option>
            <option value="PRIVATE_CAR">PRIVATE_CAR</option>
        </select>

        <label th:text="#{catalog.hotel}">Hotel</label>
        <select id="hotelType" class="form-control">
            <option value="">---</option>
            <option value="ONE_STAR">ONE_STAR</option>
            <option value="TWO_STARS">TWO_STARS</option>
            <option value="THREE_STARS">THREE_STARS</option>
            <option value="FOUR_STARS">FOUR_STARS</option>
            <option value="FIVE_STARS">FIVE_STARS</option>
        </select>

        <label th:text="#{myVoucherEdit.arrivalDate}">Arrival Date</label>
        <input id="arrivalDate" type="date" class="form-control"/>

        <label th:text="#{myVoucherEdit.evictionDate}">Eviction Date</label>
        <input id="evictionDate" type="date" class="form-control"/>

        <button class="btn btn-success" onclick="createVoucher()" th:text="#{admin.createVoucher.create}">Create</button>
    </div>
</div>

<div id="message-overlay">
    <div id="message-box">
        <ul id="message-text"></ul>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>

<span id="validationErrorText" th:text="#{admin.createVoucher.validationError}" hidden>Validation error</span>
<span id="unexpectedErrorText" th:text="#{common.unexpectedError}" hidden>Unexpected error occurred</span>
<span id="invalidYearText" th:text="#{voucher.date.yearMax4}" hidden>Year must contain exactly 4 digits</span>

<script>
    function goAdmin(){ window.location.href='/catalog'; }
    function closeMessage(){ document.getElementById('message-overlay').style.display='none'; }

    function showErrors(errors){
        const list = document.getElementById('message-text');
        list.innerHTML = '';
        errors.forEach(e => {
            const li = document.createElement('li');
            li.innerText = e;
            list.appendChild(li);
        });
        document.getElementById('message-box').className = 'error';
        document.getElementById('message-overlay').style.display = 'flex';
    }


    function isValidDateInput(value){
        if (!value) return true;
        return /^\d{4}-\d{2}-\d{2}$/.test(value);
    }

    async function createVoucher(){
        const validationErrorMsg = document.getElementById('validationErrorText')?.innerText || 'Validation error';
        const unexpectedErrorMsg = document.getElementById('unexpectedErrorText')?.innerText || 'Unexpected error occurred';
        const invalidYearMsg = document.getElementById('invalidYearText')?.innerText || 'Year must contain exactly 4 digits';

        const body = {
            title: title.value,
            description: description.value,
            price: price.value ? parseFloat(price.value) : null,
            tourType: tourType.value || null,
            transferType: transferType.value || null,
            hotelType: hotelType.value || null,
            arrivalDate: arrivalDate.value,
            evictionDate: evictionDate.value
        };

        if (!isValidDateInput(body.arrivalDate) || !isValidDateInput(body.evictionDate)) {
            showErrors([invalidYearMsg]);
            return;
        }

        try {
            const resp = await fetch('/api/vouchers/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await resp.json().catch(() => null);

            if(!resp.ok){
                if (data && typeof data === 'object') {
                    if (Array.isArray(data.errors)) {
                        showErrors(data.errors);
                        return;
                    }

                    if (data.message) {
                        showErrors([data.message]);
                        return;
                    }

                    const validationMessages = Object.values(data).filter(value => typeof value === 'string');
                    if (validationMessages.length > 0) {
                        showErrors(validationMessages);
                        return;
                    }
                }

                showErrors([validationErrorMsg]);
                return;
            }

            window.location.href='/catalog';
        } catch (error) {
            showErrors([unexpectedErrorMsg]);
        }
    }
</script>
</body>
</html>
