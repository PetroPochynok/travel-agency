<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{adminRequests.title}">Admin - Requests</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin-top: 30px; }
        .card { padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
        .btn-approve { background:#27ae60; color:white; border:none; padding:6px 10px; border-radius:6px; }
        .btn-reject { background:#e74c3c; color:white; border:none; padding:6px 10px; border-radius:6px; }
        .price { font-weight: 600; color: #2c3e50; white-space: nowrap; }
        .action-buttons { display:flex; gap:8px; align-items:center; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        .lang-switch a:hover { background-color: #1e8449; }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; font-size: 1.1rem; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        #message-box button:hover { background-color: #1c5980; }
        #confirm-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:10000; }
        #confirm-overlay .confirm-box { background:white; padding:30px 40px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.3); text-align:center; max-width:400px; }
        #confirm-overlay .confirm-box button { margin: 6px; padding:6px 14px; border:none; border-radius:6px; font-weight:600; }
        #confirm-overlay .yes { background:#27ae60; color:white; }
        #confirm-overlay .no { background:#e74c3c; color:white; }
    </style>
</head>
<body>
<div class="top-bar">
    <h4>üåç Travel Agency - Admin</h4>
    <div>
        <button onclick="goCatalog()" class="btn btn-secondary" th:text="#{admin.back}">Back</button>
    </div>
</div>

<div class="lang-switch">
    <a th:href="@{/admin/requests(lang='en')}">EN</a>
    <a th:href="@{/admin/requests(lang='uk')}">UA</a>
    <a th:href="@{/admin/requests(lang='fr')}">FR</a>
    <a th:href="@{/admin/requests(lang='de')}">DE</a>
    <a th:href="@{/admin/requests(lang='es')}">ES</a>
</div>

<div class="container">
    <div class="card">
        <h3 th:text="#{adminRequests.title}">Cancellation Requests</h3>
        <p th:text="#{adminRequests.description}">List of vouchers with cancellation requests.</p>
        <span id="lblApprove" th:text="#{admin.approve}" hidden>Approve</span>
        <span id="lblReject" th:text="#{admin.reject}" hidden>Reject</span>
        <span id="confirmApproveText" th:text="#{admin.confirm.approve}" hidden>Are you sure you want to approve this request?</span>
        <span id="confirmRejectText" th:text="#{admin.confirm.reject}" hidden>Are you sure you want to reject this request?</span>
        <span id="adminCancelApprove" th:text="#{admin.cancel.approve}" hidden>Cancellation approved and refund issued</span>
        <span id="adminCancelReject" th:text="#{admin.cancel.reject}" hidden>Cancellation rejected</span>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th th:text="#{catalog.titleCol}">Title</th>
                    <th th:text="#{catalog.description}">Description</th>
                    <th th:text="#{catalog.price}">Price</th>
                    <th th:text="#{adminRequests.user}">User</th>
                    <th th:text="#{adminRequests.requestedAt}">Requested At</th>
                    <th th:text="#{adminRequests.reason}">Reason</th>
                    <th th:text="#{adminRequests.actions}">Actions</th>
                </tr>
            </thead>
            <tbody id="requestsBody"></tbody>
        </table>
    </div>
</div>

<div id="message-overlay">
    <div id="message-box">
        <div id="message-text"></div>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>

<div id="confirm-overlay">
    <div class="confirm-box">
        <div id="confirm-text" style="font-size:1.1rem; margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button class="yes">Yes</button>
            <button class="no">No</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    function goCatalog(){ window.location.href='/catalog'; }

    function showMessage(msg, type='success'){
        const overlay=document.getElementById('message-overlay');
        const box=document.getElementById('message-box');
        box.className = type;
        document.getElementById('message-text').innerText=msg;
        overlay.style.display='flex';
    }
    function closeMessage(){ document.getElementById('message-overlay').style.display='none'; }

    async function loadRequests(){
        const token = localStorage.getItem('jwt');
        try{
            const headers = {};
            if(token) headers['Authorization'] = 'Bearer ' + token;

            const resp = await fetch('/api/vouchers/all', { headers, credentials: 'same-origin' });
            if(!resp.ok) { showMessage('Failed to load requests','error'); return; }
            const data = await resp.json();
            const vouchers = Array.isArray(data.results) ? data.results : [];
            const requests = vouchers.filter(v => v.status === 'CANCELLATION_REQUESTED');

            const tbody = document.getElementById('requestsBody');
            tbody.innerHTML = '';
            requests.forEach((v,i)=>{
                const requestedAt = v.cancellationRequestedAt ? new Date(v.cancellationRequestedAt).toLocaleString() : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${v.title}</td>
                        <td>${v.description}</td>
                        <td class="price">${v.price} $</td>
                        <td>${v.userName || ''}</td>
                        <td>${requestedAt}</td>
                        <td>${v.cancellationReason || ''}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-approve" onclick="confirmDecide('${v.id}', true)">${document.getElementById('lblApprove').innerText}</button>
                                <button class="btn-reject" onclick="confirmDecide('${v.id}', false)">${document.getElementById('lblReject').innerText}</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }catch(e){ console.error(e); showMessage('Error loading requests','error'); }
    }

    // confirm flow copied from catalog confirm modal logic
    function confirmDecide(id, approved){
        const overlay = document.getElementById('confirm-overlay');
        const confirmTextEl = document.getElementById('confirm-text');
        const yesBtn = overlay.querySelector('.yes');
        const noBtn = overlay.querySelector('.no');

        const confirmMsg = approved ? (document.getElementById('confirmApproveText').innerText) : (document.getElementById('confirmRejectText').innerText);
        confirmTextEl.innerText = confirmMsg;
        overlay.style.display = 'flex';

        function cleanup(){ overlay.style.display='none'; yesBtn.removeEventListener('click', onYes); noBtn.removeEventListener('click', onNo); }

        async function onYes(){
            cleanup();
            await doDecide(id, approved);
        }
        function onNo(){ cleanup(); }

        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
    }

    async function doDecide(id, approved){
        const token = localStorage.getItem('jwt');
        try{
            const headers = {'Content-Type':'application/json'};
            if(token) headers['Authorization'] = 'Bearer ' + token;
            const resp = await fetch(`/api/vouchers/${id}/cancel/decision`, {
                method: 'PATCH', headers, credentials: 'same-origin', body: JSON.stringify({approved})
            });
            const data = await resp.json();
            if(!resp.ok){ showMessage(data.message || 'Failed','error'); return; }
            // show localized success if available
            const successMsg = approved ? (document.getElementById('adminCancelApprove')?.innerText || 'Cancellation approved') : (document.getElementById('adminCancelReject')?.innerText || 'Cancellation rejected');
            showMessage(successMsg, 'success');
            loadRequests();
        }catch(e){ console.error(e); showMessage('Error','error'); }
    }

    window.onload = ()=>{ loadRequests(); };
</script>
</body>
</html>
