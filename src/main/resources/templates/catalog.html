<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{catalog.title}">Voucher Catalog</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h4 { margin: 0; color: #2c3e50; font-weight: 600; }
        .top-right { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; color: #2c3e50; }
        .balance { font-weight: 600; color: #27ae60; }
        .btn-logout { background-color: #e74c3c; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-logout:hover { background-color: #c0392b; }
        .btn-my-vouchers { background-color: #2980b9; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-my-vouchers:hover { background-color: #1c5980; }
        .btn-hot {background-color: #8e44ad; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-hot:hover { background-color: #732d91; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        .lang-switch a:hover { background-color: #1e8449; }
        .catalog-card { background: #ffffff; margin-top: 10px; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column;  align-items: center; }
        .table th { background-color: #f5f8fc; }
        .price { font-weight: 600; color: #2c3e50; white-space: nowrap; }
        .hot-badge { color: #e74c3c; font-weight: 700; }
        .hot-cell { text-align: center; vertical-align: middle; }
        .stars { color: #f1c40f; font-size: 1.1rem; white-space: nowrap; }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; font-size: 1.1rem; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        #message-box button:hover { background-color: #1c5980; }
        .filter-row { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; overflow-x: auto; width: 100%; justify-content: flex-start; }
        .filter-row select, .filter-row input { padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 120px; }
        .filter-row button { background-color: #27ae60; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .filter-row button:hover { background-color: #1e8449; }
        .pagination-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .pagination-controls button { padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        .pagination-controls button:disabled { background-color: #ccc; cursor: default; }
        .action-buttons { display: flex; flex-direction: column; gap: 5px;}
        .action-buttons > div { display: flex; gap: 5px;}
        .action-buttons .action-btn { flex: 0 0 48%; min-width: 0; white-space: nowrap; font-size: 0.85rem;}
        .btn-change.action-btn { background-color: #f39c12; color: white; }
        .btn-change.action-btn:hover { background-color: #d68910; }
}

}
        .btn-change { background-color: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-change:hover { background-color: #d68910; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-delete:hover { background-color: #c0392b; }
    </style>
</head>
<body>

<div class="top-bar">
    <h4>üåç Travel Agency</h4>
    <div class="top-right">
        <div class="user-name" id="userName" th:text="#{catalog.userName}">User Name</div>
        <div class="balance" id="balance" th:text="#{catalog.balance}">Balance: 0.00 $</div>
        <button class="btn-my-vouchers" onclick="goMyVouchers()" th:text="#{catalog.myVouchers}">My Vouchers</button>
        <div id="adminMenu" style="display:none; position: relative;">
            <button id="adminBtn" class="btn btn-outline-secondary" title="Admin">Admin ‚ñæ</button>
            <div id="adminDropdown" style="position:absolute; right:0; background:white; border:1px solid #ddd; padding:8px; display:none; border-radius:6px; box-shadow:0 6px 20px rgba(0,0,0,0.08);">
                <div><a href="#" onclick="goAdminRequests(); return false;" th:text="#{admin.requests}">Check requests</a></div>
                <div style="margin-top:6px;"><a href="#" onclick="goAdminCanceled(); return false;" th:text="#{admin.canceled}">Canceled</a></div>
                <div style="margin-top:6px; color:#777;"><a href="#" onclick="alert('All users not implemented yet'); return false;" th:text="#{admin.allUsers}">All users</a></div>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()" th:text="#{catalog.logout}">Logout</button>
    </div>
</div>

<div class="lang-switch">
    <a th:href="@{/catalog(lang='en')}">EN</a>
    <a th:href="@{/catalog(lang='uk')}">UA</a>
    <a th:href="@{/catalog(lang='fr')}">FR</a>
    <a th:href="@{/catalog(lang='de')}">DE</a>
    <a th:href="@{/catalog(lang='es')}">ES</a>
</div>

<div class="container">
    <div class="catalog-card">
        <h3 class="mb-4" th:text="#{catalog.title}">Voucher Catalog</h3>
        <div class="filter-row">
            <select id="tourType">
                <option value="">All Tours</option>
                <option value="HEALTH">HEALTH</option>
                <option value="SPORTS">SPORTS</option>
                <option value="LEISURE">LEISURE</option>
                <option value="SAFARI">SAFARI</option>
                <option value="WINE">WINE</option>
                <option value="ECO">ECO</option>
                <option value="ADVENTURE">ADVENTURE</option>
                <option value="CULTURAL">CULTURAL</option>
            </select>
            <select id="transferType">
                <option value="">All Transfers</option>
                <option value="BUS">BUS</option>
                <option value="TRAIN">TRAIN</option>
                <option value="PLANE">PLANE</option>
                <option value="SHIP">SHIP</option>
                <option value="PRIVATE_CAR">PRIVATE_CAR</option>
                <option value="JEEPS">JEEPS</option>
                <option value="MINIBUS">MINIBUS</option>
                <option value="ELECTRICAL_CARS">ELECTRICAL_CARS</option>
            </select>
            <select id="hotelType">
                <option value="">All Hotels</option>
                <option value="ONE_STAR">ONE_STAR</option>
                <option value="TWO_STARS">TWO_STARS</option>
                <option value="THREE_STARS">THREE_STARS</option>
                <option value="FOUR_STARS">FOUR_STARS</option>
                <option value="FIVE_STARS">FIVE_STARS</option>
            </select>
            <input type="text" id="description" th:placeholder="#{catalog.searchDescription}">
            <input type="number" id="minPrice" th:placeholder="#{catalog.minPrice}" min="0">
            <input type="number" id="maxPrice" th:placeholder="#{catalog.maxPrice}" min="0">
            <button th:text="#{catalog.search}" onclick="applyFilters()"></button>
        </div>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th th:text="#{catalog.titleCol}">Title</th>
                <th th:text="#{catalog.description}">Description</th>
                <th th:text="#{catalog.price}">Price</th>
                <th th:text="#{catalog.tour}">Tour</th>
                <th th:text="#{catalog.transfer}">Transfer</th>
                <th th:text="#{catalog.hotel}">Hotel</th>
                <th th:text="#{catalog.dates}">Dates</th>
                <th th:text="#{catalog.hot}">HOT</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="voucherTableBody"></tbody>
        </table>
        <div class="pagination-controls">
            <button id="prevPage" onclick="changePage(currentPage-1)" th:text="#{catalog.previous}">Previous</button>
            <span id="pageInfo" style="align-self:center;"></span>
            <button id="nextPage" onclick="changePage(currentPage+1)" th:text="#{catalog.next}">Next</button>
        </div>
        <p id="error" class="text-danger mt-2"></p>
    </div>
</div>
<div id="message-overlay">
    <div id="message-box">
        <div id="message-text"></div>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>
<div id="confirm-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%;
     background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:10000;">
    <div style="background:white; padding:30px 40px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.3); text-align:center; max-width:400px;">
        <div id="confirm-text" style="font-size:1.1rem; margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button id="confirm-yes" style="padding:6px 14px; border:none; border-radius:6px; background:#27ae60; color:white; font-weight:600; cursor:pointer;">Yes</button>
            <button id="confirm-no" style="padding:6px 14px; border:none; border-radius:6px; background:#e74c3c; color:white; font-weight:600; cursor:pointer;">No</button>
        </div>
    </div>
</div>
<span id="orderText" th:text="#{catalog.order}" hidden>Order</span>
<span id="changeText" th:text="#{catalog.change}" hidden>Change</span>
<span id="deleteText" th:text="#{catalog.delete}" hidden>Delete</span>
<span id="hotText" th:text="#{catalog.hotToggle}" hidden>Toggle Hot</span>
<span id="insufficientBalanceText" th:text="#{insufficient.balance}" hidden>Insufficient balance</span>
<span id="hotSuccessText" th:text="#{catalog.hotSuccess}" hidden>Status updated successfully!</span>
<span id="hotFailText" th:text="#{catalog.hotFail}" hidden>Failed to update status</span>
<span id="hotMarkText" th:text="#{catalog.hotMark}" hidden>Mark HOT</span>
<span id="hotUnmarkText" th:text="#{catalog.hotUnmark}" hidden>Unmark HOT</span>
<script th:inline="javascript">
    window.ORDER_TEXT = document.getElementById('orderText')?.innerText || 'Order';
    window.CHANGE_TEXT = document.getElementById('changeText')?.innerText || 'Change';
    window.DELETE_TEXT = document.getElementById('deleteText')?.innerText || 'Delete';
    window.HOT_TEXT = document.getElementById('hotText')?.innerText || 'Toggle Hot';
    window.INSUFFICIENT_BALANCE_TEXT = document.getElementById('insufficientBalanceText')?.innerText || 'Insufficient balance';
    window.HOT_SUCCESS_TEXT = document.getElementById('hotSuccessText')?.innerText || 'Status updated successfully!';
    window.HOT_FAIL_TEXT = document.getElementById('hotFailText')?.innerText || 'Failed to update status';

    let currentPage = 0, totalPages = 0, currentFilters = {};
    let isAdmin = false;
    let isManager = false;


    function showMessage(msg, type='success'){
        const overlay=document.getElementById('message-overlay');
        const box=document.getElementById('message-box');
        box.className = type;
        document.getElementById('message-text').innerText=msg;
        overlay.style.display='flex';
    }
    function closeMessage(){ document.getElementById('message-overlay').style.display='none'; }
    async function logout(){
        try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
        } catch (e) {
            // ignore
        }
        localStorage.removeItem('jwt');
        showMessage([[#{catalog.logoutSuccess}]], 'success');
        setTimeout(()=>window.location.href='/login',1000);
    }
    function goMyVouchers(){ window.location.href='/catalog/my'; }
    function renderStars(hotelType){ const map={ONE_STAR:1,TWO_STARS:2,THREE_STARS:3,FOUR_STARS:4,FIVE_STARS:5}; return '‚≠ê'.repeat(map[hotelType]||0);}
    function formatDate(dateStr){ const d=new Date(dateStr); return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; }

    function applyFilters(){
        currentPage=0;
        const tourType=document.getElementById('tourType').value;
        const transferType=document.getElementById('transferType').value;
        const hotelType=document.getElementById('hotelType').value;
        const description=document.getElementById('description').value;
        const minPriceInput=document.getElementById('minPrice').value;
        const maxPriceInput=document.getElementById('maxPrice').value;
        const minPrice=minPriceInput?parseFloat(minPriceInput):null;
        const maxPrice=maxPriceInput?parseFloat(maxPriceInput):null;
        if(minPrice!==null && maxPrice!==null && minPrice>maxPrice){ showMessage([[#{error.minPriceGreaterThanMax}]],'error'); return; }
        currentFilters={tourType:tourType||null, transferType:transferType||null, hotelType:hotelType||null, description:description||null, minPrice,maxPrice};
        Object.keys(currentFilters).forEach(k=>{ if(currentFilters[k]===null) delete currentFilters[k];});
        loadVouchers(currentFilters);
    }

    function changePage(newPage){ if(newPage<0||newPage>=totalPages) return; currentPage=newPage; loadVouchers(currentFilters); }

    async function loadUserInfo(){
    const token=localStorage.getItem('jwt');
    try{
        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const r=await fetch('/api/users/me',{headers, credentials: 'same-origin'});
        if(!r.ok) return;
        const u=await r.json();
        if(u && u.balance!==undefined){
    document.getElementById('userName').innerText=`${u.firstName} ${u.lastName}`;
    document.getElementById('balance').innerText=`${u.balance.toFixed(2)} $`;

    isAdmin = u.role && u.role.toUpperCase().includes('ADMIN');
    isManager = u.role && u.role.toUpperCase().includes('MANAGER');

    if (isAdmin) {
        const adminMenu = document.getElementById('adminMenu');
        if (adminMenu) adminMenu.style.display = 'block';
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) {
            adminBtn.addEventListener('click', ()=>{
                const dd = document.getElementById('adminDropdown');
                if (!dd) return;
                dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
            });
        }
    }
}
    }catch(e){ console.warn('Failed to load user info'); }
}

    async function loadVouchers(filters = {}) {
    const token = localStorage.getItem('jwt');
    // allow anonymous viewing of catalog, but if token missing we don't pre-check here
    try {
        const params = new URLSearchParams(filters);
        params.append("page", currentPage);
        params.append("size", 10);
        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const resp = await fetch('/api/vouchers/catalog?' + params.toString(), { headers, credentials: 'same-origin' });
        if (!resp.ok) throw new Error([[#{catalog.loadError}]]);
        const data = await resp.json();
        const vouchers = Array.isArray(data.vouchers) ? data.vouchers : [];
        const tbody = document.getElementById('voucherTableBody');
        tbody.innerHTML = '';

        vouchers.sort((a, b) => b.isHot - a.isHot);
        vouchers.forEach((v, i) => {
    const arrival = formatDate(v.arrivalDate);
    const eviction = formatDate(v.evictionDate);
    let markText = "üî•HOT";
    let unmarkText = "‚ùåHOT";
    let buttonText = v.isHot ? unmarkText : markText;

    let buttons = [];

    buttons.push(`
        <button class="btn btn-success action-btn btn-sm" onclick="orderVoucher('${v.id}', this)">
            ${window.ORDER_TEXT}
        </button>
    `);

    if(isAdmin) {
        buttons.push(`
            <button class="btn btn-change action-btn btn-sm" onclick="changeVoucher('${v.id}')">
                ${window.CHANGE_TEXT}
            </button>
        `);
    }

    if(isAdmin || isManager) {
        buttons.push(`
            <button class="btn btn-hot action-btn btn-sm" onclick="toggleHotStatus('${v.id}', ${v.isHot})">
                ${buttonText}
            </button>
        `);
    }

    if(isAdmin) {
        buttons.push(`
            <button class="btn btn-delete action-btn btn-sm" onclick="deleteVoucher('${v.id}')">
                ${window.DELETE_TEXT}
            </button>
        `);
    }

    let actionButtons = '';
    if(buttons.length === 1){
        actionButtons = buttons[0];
    } else {
        actionButtons = `
            <div class="action-buttons">
                <div>${buttons.slice(0, 2).join('')}</div>
                <div>${buttons.slice(2).join('')}</div>
            </div>
        `;
    }

    tbody.innerHTML += `
        <tr>
            <td>${i + 1 + currentPage * 10}</td>
            <td>${v.title}</td>
            <td>${v.description}</td>
            <td class="price">${v.price} $</td>
            <td>${v.tourType}</td>
            <td>${v.transferType}</td>
            <td class="stars">${renderStars(v.hotelType)}</td>
            <td class="dates">${arrival} ‚Äì ${eviction}</td>
            <td class="hot-cell">${v.isHot ? '<span class="hot-badge">üî•</span>' : ''}</td>
            <td>${actionButtons}</td>
        </tr>
    `;
});

        currentPage = data.currentPage;
        totalPages = data.totalPages;
        document.getElementById("pageInfo").innerText = `Page ${currentPage + 1} of ${totalPages}`;
        document.getElementById("prevPage").disabled = currentPage === 0;
        document.getElementById("nextPage").disabled = currentPage + 1 >= totalPages;
    } catch (err) {
        showMessage(err.message, 'error');
    }
}

    async function orderVoucher(voucherId, btn) {
        const overlay = document.getElementById('confirm-overlay');
        const confirmText = document.getElementById('confirm-text');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        const confirmMsg = /*[[#{catalog.orderConfirm}]]*/
            'Are you sure you want to order this voucher?';
        confirmText.innerText = confirmMsg;
        overlay.style.display = 'flex';
        function cleanUp() {
            overlay.style.display = 'none';
            yesBtn.removeEventListener('click', onYes);
            noBtn.removeEventListener('click', onNo);
        }
        async function onYes() {
            cleanUp();
            try {
                const headers = {};
                const token = localStorage.getItem('jwt');
                if (token) headers['Authorization'] = 'Bearer ' + token;

                const response = await fetch(`/api/vouchers/order/${voucherId}`, {
                    method: 'POST',
                    headers,
                    credentials: 'same-origin'
                });

                const data = await response.json();
                if (!response.ok) {
    if (data.message && data.message.includes('Insufficient balance')) {
        showMessage(window.INSUFFICIENT_BALANCE_TEXT, 'error');
    } else {
        showMessage(
            data.message || /*[[#{catalog.orderFail}]]*/ 'Order failed',
            'error'
        );
    }
    return;
}

                showMessage(
                    /*[[#{catalog.orderSuccess}]]*/ 'Order successful!',
                    'success'
                );
                loadVouchers(currentFilters);
                loadUserInfo();
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }
        function onNo() { cleanUp(); }
        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
    }

    function changeVoucher(voucherId) {
    window.location.href = `/admin/vouchers/${voucherId}/edit`;
}

    function deleteVoucher(voucherId) {
        const overlay = document.getElementById('confirm-overlay');
        const confirmText = document.getElementById('confirm-text');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        const confirmMsg = /*[[#{catalog.deleteConfirm}]]*/ 'Are you sure you want to delete this voucher?';
        confirmText.innerText = confirmMsg;
        overlay.style.display = 'flex';

        function cleanUp() {
            overlay.style.display = 'none';
            yesBtn.removeEventListener('click', onYes);
            noBtn.removeEventListener('click', onNo);
        }

        async function onYes() {
            cleanUp();
            try {
                const headers = {};
                const token = localStorage.getItem('jwt');
                if (token) headers['Authorization'] = 'Bearer ' + token;

                const response = await fetch(`/api/vouchers/${voucherId}`, {
                    method: 'DELETE',
                    headers,
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const data = await response.json();
                    showMessage(
                        data.message || 'Delete failed',
                        'error'
                    );
                    return;
                }

                showMessage(/*[[#{catalog.deleteSuccess}]]*/ 'Voucher deleted successfully!', 'success');
                loadVouchers(currentFilters);
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        function onNo() { cleanUp(); }
        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
    }

    async function toggleHotStatus(voucherId, currentStatus) {
    try {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('jwt');
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const response = await fetch(`/api/vouchers/${voucherId}/status`, {
            method: 'PATCH',
            headers: headers,
            credentials: 'same-origin',
            body: JSON.stringify({ isHot: !currentStatus })
        });

        const data = await response.json();
        if(!response.ok) {
            if (data.message && data.message.includes('Insufficient balance')) {
                showMessage(window.INSUFFICIENT_BALANCE_TEXT, 'error');
            } else {
                showMessage(data.message || 'Order failed', 'error');
            }
            return;
        }

        showMessage(window.HOT_SUCCESS_TEXT, 'success');
        loadVouchers(currentFilters);
    } catch(err) {
        showMessage(err.message, 'error');
    }
}


    window.onload = async () => {
    await loadUserInfo();
    loadVouchers();
    };

    function goAdminRequests(){ window.location.href = '/admin/requests'; }
    function goAdminCanceled(){ window.location.href = '/admin/canceled'; }
</script>
</body>
</html>
