<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{catalog.title}">Voucher Catalog</title>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h4 { margin: 0; color: #2c3e50; font-weight: 600; }
        .top-right { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; color: #2c3e50; }
        .balance { font-weight: 600; color: #27ae60; }
        .btn-logout { background-color: #e74c3c; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-logout:hover { background-color: #c0392b; }
        .btn-my-vouchers { background-color: #2980b9; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-my-vouchers:hover { background-color: #1c5980; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        .lang-switch a:hover { background-color: #1e8449; }
        .catalog-card { background: #ffffff; margin-top: 10px; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .table th { background-color: #f5f8fc; }
        .price { font-weight: 600; color: #2c3e50; white-space: nowrap; }
        .hot-badge { color: #e74c3c; font-weight: 700; }
        .hot-cell { text-align: center; vertical-align: middle; }
        .stars { color: #f1c40f; font-size: 1.1rem; white-space: nowrap; }
        #message-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; font-size: 1.1rem; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        #message-box button:hover { background-color: #1c5980; }
        .filter-row { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; flex-wrap: nowrap; overflow-x: auto; }
        .filter-row select, .filter-row input { padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 120px; }
        .filter-row button { background-color: #27ae60; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .filter-row button:hover { background-color: #1e8449; }
        .pagination-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .pagination-controls button { padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        .pagination-controls button:disabled { background-color: #ccc; cursor: default; }
    </style>
</head>
<body>

<!-- ===== Top bar ===== -->
<div class="top-bar">
    <h4>üåç Travel Agency</h4>
    <div class="top-right">
        <div class="user-name" id="userName" th:text="#{catalog.userName}">User Name</div>
        <div class="balance" id="balance" th:text="#{catalog.balance}">Balance: 0.00 $</div>
        <button class="btn-my-vouchers" onclick="goMyVouchers()" th:text="#{catalog.myVouchers}">My Vouchers</button>
        <button class="btn-logout" onclick="logout()" th:text="#{catalog.logout}">Logout</button>
    </div>
</div>

<!-- ===== Language switch ===== -->
<div class="lang-switch">
    <a th:href="@{/catalog(lang='en')}">EN</a>
    <a th:href="@{/catalog(lang='uk')}">UA</a>
    <a th:href="@{/catalog(lang='fr')}">FR</a>
    <a th:href="@{/catalog(lang='de')}">DE</a>
    <a th:href="@{/catalog(lang='es')}">ES</a>
</div>

<div class="container">
    <div class="catalog-card">
        <h3 class="mb-4" th:text="#{catalog.title}">Voucher Catalog</h3>

        <!-- ===== Filters in 1 row ===== -->
        <div class="filter-row">
            <select id="tourType">
                <option value="">All Tours</option>
                <option value="HEALTH">HEALTH</option>
                <option value="SPORTS">SPORTS</option>
                <option value="LEISURE">LEISURE</option>
                <option value="SAFARI">SAFARI</option>
                <option value="WINE">WINE</option>
                <option value="ECO">ECO</option>
                <option value="ADVENTURE">ADVENTURE</option>
                <option value="CULTURAL">CULTURAL</option>
            </select>

            <select id="transferType">
                <option value="">All Transfers</option>
                <option value="BUS">BUS</option>
                <option value="TRAIN">TRAIN</option>
                <option value="PLANE">PLANE</option>
                <option value="SHIP">SHIP</option>
                <option value="PRIVATE_CAR">PRIVATE_CAR</option>
                <option value="JEEPS">JEEPS</option>
                <option value="MINIBUS">MINIBUS</option>
                <option value="ELECTRICAL_CARS">ELECTRICAL_CARS</option>
            </select>

            <select id="hotelType">
                <option value="">All Hotels</option>
                <option value="ONE_STAR">ONE_STAR</option>
                <option value="TWO_STARS">TWO_STARS</option>
                <option value="THREE_STARS">THREE_STARS</option>
                <option value="FOUR_STARS">FOUR_STARS</option>
                <option value="FIVE_STARS">FIVE_STARS</option>
            </select>

            <input type="text" id="description" th:placeholder="#{catalog.searchDescription}">
            <input type="number" id="minPrice" th:placeholder="#{catalog.minPrice}" min="0">
            <input type="number" id="maxPrice" th:placeholder="#{catalog.maxPrice}" min="0">
            <button th:text="#{catalog.search}" onclick="applyFilters()"></button>
        </div>

        <!-- ===== Voucher Table ===== -->
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th th:text="#{catalog.titleCol}">Title</th>
                <th th:text="#{catalog.description}">Description</th>
                <th th:text="#{catalog.price}">Price</th>
                <th th:text="#{catalog.tour}">Tour</th>
                <th th:text="#{catalog.transfer}">Transfer</th>
                <th th:text="#{catalog.hotel}">Hotel</th>
                <th th:text="#{catalog.dates}">Dates</th>
                <th th:text="#{catalog.hot}">HOT</th>
                <th>Order</th>
            </tr>
            </thead>
            <tbody id="voucherTableBody"></tbody>
        </table>

        <!-- ===== Pagination Controls ===== -->
        <div class="pagination-controls">
            <button id="prevPage" onclick="changePage(currentPage-1)" th:text="#{catalog.previous}">Previous</button>
            <span id="pageInfo" style="align-self:center;"></span>
            <button id="nextPage" onclick="changePage(currentPage+1)" th:text="#{catalog.next}">Next</button>
        </div>

        <p id="error" class="text-danger mt-2"></p>
    </div>
</div>

<span id="orderText" th:text="#{catalog.order}" style="display:none;"></span>

<!-- ===== Centered Message Overlay ===== -->
<div id="message-overlay">
    <div id="message-box">
        <div id="message-text"></div>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>

<script th:inline="javascript">
    let currentPage = 0;
    let totalPages = 0;
    let currentFilters = {};

    function showMessage(msg, type='success') {
        const overlay = document.getElementById('message-overlay');
        const box = document.getElementById('message-box');
        const text = document.getElementById('message-text');
        text.innerText = msg;
        box.className = type;
        overlay.style.display='flex';
    }

    function closeMessage() { document.getElementById('message-overlay').style.display='none'; }

    async function logout() {
        localStorage.removeItem('jwt');
        showMessage([[#{catalog.logoutSuccess}]], 'success');
        setTimeout(()=>window.location.href='/login',1000);
    }

    function goMyVouchers(){ window.location.href='/catalog/my'; }

    function renderStars(hotelType) {
        const map={ONE_STAR:1,TWO_STARS:2,THREE_STARS:3,FOUR_STARS:4,FIVE_STARS:5};
        return '‚≠ê'.repeat(map[hotelType]||0);
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2,'0');
        const month = String(date.getMonth()+1).padStart(2,'0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    function applyFilters() {
        currentPage = 0; // —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º—É —Ñ—ñ–ª—å—Ç—Ä—ñ
        const tourType = document.getElementById('tourType').value;
        const transferType = document.getElementById('transferType').value;
        const hotelType = document.getElementById('hotelType').value;
        const description = document.getElementById('description').value;
        const minPriceInput = document.getElementById('minPrice').value;
        const maxPriceInput = document.getElementById('maxPrice').value;

        const minPrice = minPriceInput ? parseFloat(minPriceInput) : null;
        const maxPrice = maxPriceInput ? parseFloat(maxPriceInput) : null;

        if (minPrice !== null && maxPrice !== null && minPrice > maxPrice) {
            showMessage([[#{error.minPriceGreaterThanMax}]], 'error');
            return;
        }

        currentFilters = {
            tourType: tourType || null,
            transferType: transferType || null,
            hotelType: hotelType || null,
            description: description || null,
            minPrice: minPrice,
            maxPrice: maxPrice
        };

        loadVouchers(currentFilters);
    }

    function changePage(newPage) {
        if(newPage < 0 || newPage >= totalPages) return;
        currentPage = newPage;
        loadVouchers(currentFilters);
    }

    async function loadUserInfo() {
        const token = localStorage.getItem('jwt'); if(!token) return;
        try {
            const response = await fetch('/api/users/me',{headers:{'Authorization':'Bearer '+token}});
            if(!response.ok) return;
            const user = await response.json();
            if(user && user.balance !== undefined){
                document.getElementById('userName').innerText = `${user.firstName} ${user.lastName}`;
                document.getElementById('balance').innerText = `${user.balance.toFixed(2)} $`;
            }
        } catch(e){ console.warn('Failed to load user info'); }
    }

    async function loadVouchers(filters={}) {
        const token = localStorage.getItem('jwt');
        if(!token){ window.location.href='/login'; return; }

        const orderText = document.getElementById('orderText').innerText;

        try {
            const params = new URLSearchParams(filters);
            params.append("page", currentPage);
            params.append("size", 10); // –∞–±–æ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –∑–º—ñ–Ω–Ω–∏–º —á–µ—Ä–µ–∑ UI

            const response = await fetch('/api/vouchers/catalog?' + params.toString(), {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (!response.ok) throw new Error([[#{catalog.loadError}]]);

            const data = await response.json();
            const vouchers = Array.isArray(data.vouchers) ? data.vouchers : [];
            const tbody = document.getElementById('voucherTableBody');
            tbody.innerHTML = '';
            vouchers.sort((a,b)=>b.isHot - a.isHot);

            vouchers.forEach((v,index)=>{
                const arrival = formatDate(v.arrivalDate);
                const eviction = formatDate(v.evictionDate);
                tbody.innerHTML+=`
                    <tr>
                        <td>${index+1 + currentPage*10}</td>
                        <td>${v.title}</td>
                        <td>${v.description}</td>
                        <td class="price">${v.price} $</td>
                        <td>${v.tourType}</td>
                        <td>${v.transferType}</td>
                        <td class="stars">${renderStars(v.hotelType)}</td>
                        <td>${arrival} ‚Äì ${eviction}</td>
                        <td class="hot-cell">${v.isHot ? '<span class="hot-badge">üî•</span>' : ''}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="orderVoucher('${v.id}')">
                                ${orderText}
                            </button>
                        </td>
                    </tr>
                `;
            });

            // –æ–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            currentPage = data.currentPage;
            totalPages = data.totalPages;
            document.getElementById("pageInfo").innerText = `Page ${currentPage+1} of ${totalPages}`;
            document.getElementById("prevPage").disabled = currentPage===0;
            document.getElementById("nextPage").disabled = currentPage+1>=totalPages;

        } catch(err){
            showMessage(err.message,'error');
        }
    }

    async function orderVoucher(voucherId){
        const token = localStorage.getItem('jwt'); if(!token) return;
        try {
            const response = await fetch(`/api/vouchers/order/${voucherId}`,{
                method:'POST', headers:{'Authorization':'Bearer '+token}
            });
            const data = await response.json();
            if(!response.ok){
                const msg = data.message || [[#{catalog.orderFailed}]];
                showMessage(msg,'error');
                return;
            }
            showMessage([[#{catalog.orderSuccess}]],'success');
            loadVouchers(currentFilters); loadUserInfo();
        } catch(err){ showMessage(err.message,'error'); }
    }

    window.onload = ()=>{ loadUserInfo(); loadVouchers(); };
</script>

</body>
</html>
