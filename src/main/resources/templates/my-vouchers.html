<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{myVouchers.title}">My Vouchers</title>

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
        body { background-color: #eef4fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .top-bar { background: #ffffff; padding: 15px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h4 { margin: 0; color: #2c3e50; font-weight: 600; }
        .top-right { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; color: #2c3e50; }
        .balance { font-weight: 600; color: #27ae60; }
        .btn-logout, .btn-back-catalog { padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; }
        .btn-logout { background-color: #e74c3c; color: white; }
        .btn-logout:hover { background-color: #c0392b; }
        .btn-back-catalog { background-color: #2980b9; color: white; }
        .btn-back-catalog:hover { background-color: #1c5980; }
        .btn-profile { background-color: #2c3e50; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-profile:hover { background-color: #1f2a36; }
        .lang-switch { text-align: center; margin: 15px 0; }
        .lang-switch a { margin: 0 5px; padding: 5px 10px; border-radius: 5px; background-color: #27ae60; color: white; font-weight: 600; text-decoration: none; font-size: 0.85rem; }
        .lang-switch a:hover { background-color: #1e8449; }
        .catalog-card { background: #ffffff; margin-top: 10px; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
        .table th { background-color: #f5f8fc; text-align: center; }
        .table td { vertical-align: middle; }
        .price { font-weight: 600; color: #2c3e50; white-space: nowrap; }
        .dates { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; vertical-align: middle; }
        .hot-badge { color: #e74c3c; font-weight: 700; display: block; }
        .hot-cell { text-align: center; vertical-align: middle; }
        .stars { color: #f1c40f; font-size: 1.1rem; white-space: nowrap; }
        #message-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        #message-box { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; font-size: 1.1rem; }
        #message-box.success { border-left: 6px solid #27ae60; }
        #message-box.error { border-left: 6px solid #e74c3c; }
        #message-box button { margin-top: 15px; padding: 6px 14px; border: none; border-radius: 6px; background-color: #2980b9; color: white; font-weight: 600; cursor: pointer; }
        #message-box button:hover { background-color: #1c5980; }
        .btn-cancel { background-color: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-cancel:hover { background-color: #d35400; }
    </style>
</head>
<body>

<div class="top-bar">
    <h4>üåç Travel Agency</h4>
    <div class="top-right">
        <button class="btn-profile" id="profileBtn" onclick="goProfile()" th:text="#{profile.viewButton}">Profile</button>

        <div style="position: relative;">
            <button id="balanceBtn" class="btn btn-outline-success" style="margin-left:8px;">
                Balance: <span id="balanceAmount">0.00 $</span> ‚ñæ
            </button>
            <div id="balanceDropdown"
                 style="display:none; position:absolute; right:0; background:white; border:1px solid #ddd;
                padding:8px; border-radius:6px; box-shadow:0 6px 20px rgba(0,0,0,0.08);">
                <div><a href="#" onclick="goDeposit(); return false;" th:text="#{balance.deposit}">Deposit</a></div>
                <div style="margin-top:6px;"><a href="#" onclick="goWithdraw(); return false;" th:text="#{balance.withdraw}">Withdraw</a></div>
            </div>
        </div>

        <button class="btn-back-catalog" onclick="goBackCatalog()" th:text="#{myVouchers.backCatalog}">Back to Catalog</button>
        <button class="btn-logout" onclick="logout()" th:text="#{catalog.logout}">Logout</button>
    </div>
</div>

<div class="lang-switch">
    <a th:href="@{/catalog/my(lang='en')}">EN</a>
    <a th:href="@{/catalog/my(lang='uk')}">UA</a>
    <a th:href="@{/catalog/my(lang='fr')}">FR</a>
    <a th:href="@{/catalog/my(lang='de')}">DE</a>
    <a th:href="@{/catalog/my(lang='es')}">ES</a>
</div>

<span id="lblActions" th:text="#{myVouchers.actions}" hidden>Actions</span>
<span id="lblCancel" th:text="#{myVouchers.cancel}" hidden>Cancel</span>
<span id="lblCancelConfirm" th:text="#{myVouchers.cancelConfirm}" hidden>Request cancellation?</span>
<span id="lblCancelRequested" th:text="#{myVouchers.cancelRequested}" hidden>Cancellation requested</span>
<span id="lblCancelReasonPlaceholder" th:text="#{myVouchers.cancelReasonPlaceholder}" hidden>Optional reason</span>

<div class="container">
    <div class="catalog-card">
        <h3 class="mb-4" th:text="#{myVouchers.title}">My Vouchers</h3>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th th:text="#{catalog.titleCol}">Title</th>
                <th th:text="#{catalog.description}">Description</th>
                <th th:text="#{catalog.price}">Price</th>
                <th th:text="#{catalog.tour}">Tour</th>
                <th th:text="#{catalog.transfer}">Transfer</th>
                <th th:text="#{catalog.hotel}">Hotel</th>
                <th th:text="#{catalog.dates}">Dates</th>
                <th th:text="#{catalog.hot}">HOT</th>
                <th id="actionsHeader" th:text="#{myVouchers.actions}">Actions</th>
            </tr>
            </thead>
            <tbody id="voucherTableBody"></tbody>
        </table>
        <p id="error" class="text-danger mt-2"></p>
    </div>
</div>

<div id="message-overlay">
    <div id="message-box">
        <div id="message-text"></div>
        <button onclick="closeMessage()">OK</button>
    </div>
</div>

<!-- Cancel modal -->
<div id="cancel-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:10000;">
    <div style="background:white; padding:20px 24px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.3); max-width:420px; width:100%;">
        <div id="cancel-text" style="font-size:1.05rem; margin-bottom:10px;"></div>
        <textarea id="cancel-reason" class="form-control" rows="3"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
            <button id="cancel-confirm" style="padding:6px 14px; border:none; border-radius:6px; background:#27ae60; color:white; font-weight:600;">Confirm</button>
            <button id="cancel-cancel" style="padding:6px 14px; border:none; border-radius:6px; background:#e74c3c; color:white; font-weight:600;">Close</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const LABELS = {
        actions: document.getElementById('lblActions')?.innerText || 'Actions',
        cancel: document.getElementById('lblCancel')?.innerText || 'Cancel',
        cancelConfirm: document.getElementById('lblCancelConfirm')?.innerText || 'Request cancellation?',
        cancelRequested: document.getElementById('lblCancelRequested')?.innerText || 'Cancellation requested',
        cancelReasonPlaceholder: document.getElementById('lblCancelReasonPlaceholder')?.innerText || 'Optional reason'
    };

    function showMessage(msg, type='success') {
        const overlay = document.getElementById('message-overlay');
        const box = document.getElementById('message-box');
        const text = document.getElementById('message-text');
        text.innerText = msg;
        box.className = type;
        overlay.style.display='flex';
    }

    function goBackCatalog() {
    window.location.href = "/catalog";
    }
    function goProfile() {
        window.location.href = "/profile";
    }

    function closeMessage() { document.getElementById('message-overlay').style.display='none'; }

    async function loadUserInfo() {
        const token = localStorage.getItem('jwt');
        try {
            const headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            const response = await fetch('/api/users/me', { headers, credentials: 'same-origin' });
            if (!response.ok) return;
            const user = await response.json();
            if (user) {
                const profileBtn = document.getElementById('profileBtn');
                if (profileBtn) profileBtn.innerText = `${user.firstName} ${user.lastName}`;
                const balEl = document.getElementById('balanceAmount');
if (balEl) balEl.innerText = `${user.balance.toFixed(2)}$`;

const balanceBtn = document.getElementById('balanceBtn');
if (balanceBtn) {
    balanceBtn.addEventListener('click', () => {
        const dd = document.getElementById('balanceDropdown');
        if (!dd) return;
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });
}
            }
        } catch (e) { console.warn('Failed to load user info'); }
    }

    function goDeposit() { window.location.href = '/deposit'; }
    function goWithdraw() { window.location.href = '/withdraw'; }

    function logout() {
        try { fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }); } catch(e){}
        localStorage.removeItem('jwt');
        showMessage([[#{catalog.logoutSuccess}]], 'success');
        setTimeout(()=>window.location.href='/login',1000);
    }

    function goBack() {
    window.location.href = "https://localhost:8443/catalog";
}

    function renderStars(hotelType) {
        const map={ONE_STAR:1,TWO_STARS:2,THREE_STARS:3,FOUR_STARS:4,FIVE_STARS:5};
        return '‚≠ê'.repeat(map[hotelType]||0);
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2,'0');
        const month = String(date.getMonth()+1).padStart(2,'0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    let pendingCancelId = null;

    async function loadMyVouchers() {
    const token = localStorage.getItem('jwt');

    try {
        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const response = await fetch('/api/vouchers/my', { headers, credentials: 'same-origin' });
        if (response.status === 401) { window.location.href = '/login'; return; }
        if(!response.ok) throw new Error('Failed to load your vouchers');

        const result = await response.json();
        const vouchers = Array.isArray(result.results) ? result.results : [];

        const tbody = document.getElementById('voucherTableBody');
        tbody.innerHTML = '';
        vouchers.sort((a,b)=>b.isHot - a.isHot);

        vouchers.forEach((v,index)=>{
            const arrival = formatDate(v.arrivalDate);
            const eviction = formatDate(v.evictionDate);

            let actions = '';
            if (v.status === 'PAID') {
                actions += `<button class="btn btn-cancel btn-sm" onclick="openCancel('${v.id}')">${LABELS.cancel}</button>`;
            }

            tbody.innerHTML+=`
                <tr>
                    <td>${index+1}</td>
                    <td>${v.title}</td>
                    <td>${v.description}</td>
                    <td class="price">${v.price} $</td>
                    <td>${v.tourType}</td>
                    <td>${v.transferType}</td>
                    <td class="stars">${renderStars(v.hotelType)}</td>
                    <td class="dates">${arrival} ‚Äì ${eviction}</td>
                    <td class="hot-cell">${v.isHot ? '<span class="hot-badge">üî•</span>' : ''}</td>
                    <td class="text-center">${actions}</td>
                </tr>
            `;
        });

    } catch(err){
        showMessage(err.message,'error');
    }
}

    function openCancel(id) {
        pendingCancelId = id;
        document.getElementById('cancel-text').innerText = LABELS.cancelConfirm;
        const textarea = document.getElementById('cancel-reason');
        textarea.value = '';
        textarea.placeholder = LABELS.cancelReasonPlaceholder;
        document.getElementById('cancel-overlay').style.display = 'flex';
    }

    function closeCancel() {
        pendingCancelId = null;
        document.getElementById('cancel-overlay').style.display = 'none';
    }

    document.getElementById('cancel-cancel').addEventListener('click', closeCancel);
    document.getElementById('cancel-confirm').addEventListener('click', async ()=>{
        const reason = document.getElementById('cancel-reason').value || null;
        const token = localStorage.getItem('jwt');
        try {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;

            const response = await fetch(`/api/vouchers/${pendingCancelId}/cancel`, {
                method: 'PATCH',
                headers,
                credentials: 'same-origin',
                body: JSON.stringify({ reason })
            });

            const data = await response.json();
            if (!response.ok) {
                showMessage(data.message || 'Cancellation failed', 'error');
                closeCancel();
                return;
            }

            showMessage(LABELS.cancelRequested, 'success');
            closeCancel();
            loadMyVouchers();
        } catch (err) {
            showMessage(err.message, 'error');
            closeCancel();
        }
    });


    window.onload = ()=>{ loadUserInfo(); loadMyVouchers(); };
</script>

</body>
</html>
